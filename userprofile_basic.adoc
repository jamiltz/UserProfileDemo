= User Profile Sample: Couchbase Lite Fundamentals
:idprefix:
:idseparator: -
:icons: font
:quick-uri: https://asciidoctor.org/docs/asciidoc-syntax-quick-reference/
:page-aliases: tutorials:userprofile-couchbase-mobile-xamarin:standalone/userprofile/userprofile_basic
:imagesdir: ./images
ifndef::env-site,env-github[]
:toc: left
:toclevels: 3
endif::[]

toc::[]

== Introduction
Couchbase Mobile brings the power of NoSQL to the edge. It is comprised of three components:

* *Couchbase Lite*, an embedded, NoSQL JSON Document Style database for your mobile apps.
* *Sync Gateway*, an internet-facing synchronization mechanism that securely syncs data between mobile clients and server.
* *Couchbase Server*, a highly scalable, distributed NoSQL database platform.

Couchbase Mobile supports flexible deployment models. You can deploy

* Couchbase Lite as a standalone embedded database within your mobile apps or,
* Couchbase Lite enabled mobile clients with a Sync Gateway to sychronize data between your mobile clients or,
* Couchbase Lite enabled clients with a Sync Gateway to sync data between mobile clients and the Couchbase Server, which can persist data in the cloud (public or private) 

This tutorial will walk you through a very basic example of how you can use *Couchbase Lite 2.x in standalone mode* within your Xamarin app for *iOS*, *Android*, and *UWP*. 

You will learn the fundamentals of

* Database Operations
* Document CRUD Operations


====
You can learn more about Couchbase Mobile https://developer.couchbase.com/mobile[here]
====

== Prerequisites
This tutorial assumes familiarity with building link:https://www.xamarin.com[Xamarin] apps with C# and XAML.

* UWP (Windows 10)

* Android (7.x+) 

* iOS (Xcode 10+) 
  Download latest version from the link:https://itunes.apple.com/us/app/xcode/id497799835?mt=12[Mac App Store]
                
* git (Optional)
This is required if you would prefer to pull the source code from GitHub repo.
** Create a link:https://github.com[free github account] if you don't already have one
** git can be downloaded from link:https://git-scm.com/book/en/v2/Getting-Started-Installing-Git[git-scm.org]

== App Overview
We will be working with a very simple app. It does one thing -

* Allows users to log in and create or update his/her user profile information

The user profile information is persisted as a Document in the local Couchbase Lite Database. So subsquently, when the user logs out and logs back in again, the profile information is loaded from the Database.

image::https://raw.githubusercontent.com/couchbaselabs/userprofile-couchbase-mobile/standalone/content/modules/userprofile/assets/images/user_profile.gif[App Overview]

== Installation

=== Fetching App Source Code

==== Option 1 : Git Clone

- Clone the *_standalone_* branch of the `User Profile Demo` project from GitHub. Type the following command in your terminal
+
[source,bash] 
----
  git clone -b standalone https://github.com/couchbaselabs/userprofile-couchbase-mobile-xamarin.git
----

==== Option 2 : Download .zip

- Download the  `User Profile Demo` project from link:https://github.com/couchbaselabs/userprofile-couchbase-mobile-xamarin/archive/standalone.zip[here]

=== Installing Couchbase Lite Framework

- Next, we will download the Couchbase Lite 2.0 framework. The Couchbase Lite Nuget package is link:hhttps://www.nuget.org/packages/Couchbase.Lite/[distributed] via Nuget.org. In our example, we will be downloading the pre-built version of the framework. For this, do the following
+
[source,bash] 
----
  cd /path/to/UserProfileDemo/content/modules/userprofile/examples

  nuget install Couchbase.Lite
----

Now, let's verify the installation

=== Try it out
* Open the `UserProfileDemo.sln`. The project would be located at `/path/to/UserProfileDemo/content/modules/userprofile/examples`
+
[source,bash]
----
open UserProfileDemo.sln
----
+
* Build the solution using Visual Studio (or Visual Studio for Mac on macOS).
* Run the app on a device or simulator/emulator.
* Verify that you see the login screen
+
image::user_profile_login.png[User Profile Login Screen Image]

== Initiliazing Couchbase Lite 

=== iOS

=== Android

=== UWP


== Data Model
Couchbase Lite is a JSON Document Store. A Document is a logical collection of named fields and values.The values are any valid JSON types. In addition to the standard JSON types, Couchbase Lite supports `Date` and `Blob` data types. 
While it is not required or enforced, it is a recommended practice to include a _"type"_ property that can serve as a namespace for related documents. 

=== The "User Profile" Document
The app deals with a single Document with a _"type"_ property of _"user"_.  The document ID is of the form _"user::<email>"_.
An example of a document would be 

```json
{
    "type":"user",
    "name":"Jane Doe",
    "email":"jane.doe@earth.org",
    "address":"101 Main Street",
    "image":CBLBlob (image/jpg) // <1>
}
```
<1> Special link:https://developer.couchbase.com/documentation/mobile/2.0/couchbase-lite/swift.html#blobs[`Blob`] data type that is associated with the profile image.  

=== UserProfile 

The _"user"_ Document is encoded to a class named _UserProfile_.

[source,c#]
----
include::./src/UserProfileDemo.Models/UserProfile.cs[tags=userprofile]
----

== Basic Database Operations
In this section, we will do a code walkthrough of the basic Database operations

=== Create / Open a Database
When a user logs in, we create an empty Couchbase Lite database for the user if one does not exist.

* Open the *BaseRepository.cs* file and locate the `Database` property. When the `Database` property is used for the first time a Couchbase Lite database will be opened, or created if it does not already exist via the instantiation of a new object.
+
[source,c#]
----
include::./src/UserProfileDemo.Repositories/BaseRepository.cs[tags=database]
----

* We create an instance of the `DatabaseConfiguration` within `UserProfileRepository` via an `abstract` requirement from the parent class, `BaseRepository`. This is an optional step. In our case, we would like to override the default path of the database. Every user has their own instance of the Database that is located in a folder corresponding to the user. Please note that the default path is platform specific.
+
[source,c#]
---- 
include::./src/UserProfileDemo.Repositories/UserProfileRepository.cs[tags=databaseconfiguration]
----

* A local Couchbase Lite database named *_"userprofile"_* for the user. If a database already exists for the user, the existing version is returned.
+ 
[source,c#] 
----
include::./src/UserProfileDemo.Repositories/BaseRepository.cs[tags=databasecreate]
---- 

=== Listening to Database Changes
You can be asynchornously notified of any change (add, delete, update) to the Database by registering a change listener with the Database. In our app, we are not doing anything special with the Database change notification other than logging the change. In a real world app, you would use this notification for instance, to update the UI.

* Open the *BaseRepository.cs* file and locate the `Database.AddChangeListener` function usage within the constructor. To register a change listener with the database we add the delegate method `OnDatabaseChangeEvent`. This is an optional step. The `AddChangeListener` method returns a `ListenerToken`. The `ListenerToken` is required to remove the listener from the database.
[source,c#]
+
----
include::./src/UserProfileDemo.Repositories/BaseRepository.cs[tags=registerForDatabaseChanges]
----

* The listener is a delegate method that takes two parameters of type `object` and `DatabaseChangedEventArgs` respectively. 
+
[source,c#] 
---- 
include::./src/UserProfileDemo.Repositories/BaseRepository.cs[tags=addChangeListener]
----

=== Closing the Database
When a user logs out, we close the Couchbase Lite database associated with the user, deregister any database change listeners, and free up memory allocations.

Open the *BaseRepository.cs* file and locate the `Dispose` method. In our sample `Dispose` handles the removal of database listeners, removing various objects from memory, and closing the database.  `Dispose` will be called when a user logs out. 

[source,c#] 
----
include::./src/UserProfileDemo.Repositories/BaseRepository.cs[tags=databaseClose]
----

=== Deregistering for  Database Changes

* Open the *DatabaseManager.swift* file and locate the `deregisterForDatabaseChanges()` function. 
+
[source,swift]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=deregisterForDatabaseChanges]
----

* We stop listening to database changes by passing in the `ListenerToken` associated with the listener.
+
[source,swift]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=removedbchangelistener]
----

=== Try it out
* The app can be tested using a simulator/emulator or device.
* Log into the app with any username and password. Let's use the values _"demo@example.com"_ and _"password"_ for username and password fields respectively. If this is the first time that the user is signing in, a new Couchbase Lite database will be created. If not, the user's existing database will be opened.

=== Confirmation of Results (iOS)
* Confirm that the console log output has a message similar to the one below. In my example, I am logging in with a username of _"demo@example.com"_.
+
[source,bash]
----
Will open/create DB  at path Will open/create DB  at path /Users/priya.rajagopal/Library/Developer/CoreSimulator/Devices/E4E62394-9940-4AF8-92FC-41E3C794B216/data/Containers/Data/Application/65EAD047-B29A-400C-803F-F799BAE99CBA/Library/Application Support/demo@example.com
---- 
* The above log message indicates the location of the database for the user
* Open the folder in your Finder app and verify that a database with name _"userprofile"_ is exists for the user
+
image::db_location.png[User Profile Database Location]

== Document Operations
Once an instance of the Couchbase Lite database is created/opened for the specific user, we can perform basic Document functions on the database. In this section, we will walkthrough the code that describes basic Document operations

=== Reading a Document
Once the user logs in, the user is taken to the "Your Profile" screen. A request is made to load  <<The "User Profile" Document>>  for the user. When the user logs in the very first time, there would be no _user profile_ document for the user.

* Open the *UserProfileViewModel.cs* file and locate the `userProfileDocId` definition. This document Id is constructed by prefixing the term "user::" to the username of the user.
+
[source,c#]
----
include::./src/UserProfileDemo.Core/ViewModels/UserProfileViewModel.cs[tags=userProfileDocId] 
----

* The `UserProfileViewModel` is tasked with retrieving the profile for a logged in user. It does this by using a class that implements `IUserProfileRepository`.
+
[source,c#]
----
include::./src/UserProfileDemo.Core/ViewModels/UserProfileViewModel.cs[tags=getUserProfileUsingRepo] 
----

* In the *UserProfileRepository.cs* file, locate the `GetUserProfile` function.
+
[source,c#]
----
include::./src/UserProfileDemo.Repositories/UserProfileRepository.cs[tags=getUserProfile]
----

* We try to fetch the document with specified `userProfileDocId` from the database.
+
[source,c#] 
----
include::./src/UserProfileDemo.Repositories/UserProfileRepository.cs[tags=docfetch]
----
<1> Fetch an *immutable* copy of the Document from the database.
<2> Create an instance of <<UserProfile>> object.
<3> Set the `email` property of the UserProfile with the username of the logged in user. *Note:* This value is not editable after it's initially saved.
<4> If document exists and is fetched succesfully, we use appropriate type-getters to fetch the various members of the Document based on the property name. Specifically, note the support of the `GetBlob` type to fetch the value of a property of type `Blob`.

=== Creating / Updating a Document
A <<The "User Profile" Document>> is created for the user when the user taps the "Done" button on the "Profile Screen". 
The function below applies whether you are creating a document or updating an existing version

* The `UserProfileViewModel` is tasked with setting values of a profile for a logged in user, and saving them to the database. It does this by using a class that implements `IUserProfileRepository`.
+
[source,c#]
----
include::./src/UserProfileDemo.Core/ViewModels/UserProfileViewModel.cs[tags=saveUserProfileUsingRepo] 
----

* Open the *UserProfileRepository.cs* file and locate the `SaveUserProfile` method.
+ 
[source,c#]
----
include::./src/UserProfileDemo.Repositories/UserProfileRepository.cs[tags=saveUserProfile]
----


* We create a *mutable* instance of the Document. By default, all APIs in Couchbase Lite deal with immutable objects, thereby making them *thread-safe* by design. In order to mutate an object, you must explicitly get a mutable copy of the object.
Use appropriate type-setters to set the various properties of the Document  
+
[source,c#]
----
include::./src/UserProfileDemo.Repositories/UserProfileRepository.cs[tags=docSet]
----
<1> Specifically, note the support of the `SetBlob` type to fetch the value of a property of type `Blob`.

* Save the document
+
[source,swift]
----
include::./src/UserProfileDemo.Repositories/UserProfileRepository.cs[tags=docSave]
----


=== Deleting a Document
We don't delete a Document in this sample app. However, deletion of a document is pretty straightforward and this is how you would do it.
[source,c#]
----
var document = Database.GetDocument(id);

if (document != null)
{
    Database.Delete(document);
}
----

=== Try It Out
* You should have followed the steps discussed in the "Try It Out" section under <<Create / Open a Database>>
* Enter a "name" for the user in the Text Entry box and Tap "Done"
* Confirm that you see an alert message "Succesfully Updated Profile". The first time, you update the profile screen, the Document will be created. 
+
image::doc_create.png[User Profile Document Creation]
+
* Now tap on the "Tap!" button and select an image from the Photo Album. Tap "Done".
+
image::https://raw.githubusercontent.com/couchbaselabs/userprofile-couchbase-mobile/standalone/content/modules/userprofile/assets/images/image_selection.gif[Image Selection]
+
* Confirm that you see an alert message "Succesfully Updated Profile". The Document will be updated this time.
* Tap "Log Off" and log out of the app
* Log back into the app with the same user email Id and password that you used earlier. In my example, I used _"demo@example.com"_ and _"password"_. So I will log in with those credentials again.
* Confirm that you see the profile screen  with the _name_ and _image_ values that you set earlier. 
+
image::https://raw.githubusercontent.com/couchbaselabs/userprofile-couchbase-mobile/standalone/content/modules/userprofile/assets/images/log_off_on.gif[Log Off and Log Back On]

== Learn More
Congratulations on completing this tutorial!

This tutorial walked you through a very basic example of how to get up and running with Couchbase Lite as a local-only, standalone embedded data store in your iOS app. If you want to learn more about Couchbase Mobile 2.x, check out the following links.

=== Further Reading
* link:https://blog.couchbase.com/couchbase-mobile-2-0/[Introduction to Couchbase Mobile]

* link:https://blog.couchbase.com/couchbase-mobile-2-0/[Couchbase Mobile 2.0 Overview]

* link:https://developer.couchbase.com/documentation/mobile/2.0/couchbase-lite/swift.html#getting-started[Getting Started with Couchbase Lite in iOS]

* link:https://developer.couchbase.com/documentation/mobile/2.0/couchbase-lite/index.html[Couchbase Lite Reference Guide]

* link:https://blog.couchbase.com/category/couchbase-mobile/[Couchbase Mobile Blogs]
